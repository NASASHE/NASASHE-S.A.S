rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function userDoc() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid));
    }

    function isAdmin() {
      return signedIn() && userDoc().data.rol == 'admin';
    }

    function moduloValido(modulo) {
      return modulo == 'compras'
        || modulo == 'ventas'
        || modulo == 'gastos'
        || modulo == 'ventasMenores'
        || modulo == 'remisiones';
    }

    function bloqueValido(data) {
      return data.deviceId is string
        && data.deviceId.size() > 0
        && data.ownerUid is string
        && data.ownerUid.size() > 0
        && moduloValido(data.modulo)
        && data.inicio is int
        && data.fin is int
        && data.siguiente is int
        && data.tamano is int
        && data.tamano > 0
        && data.fin >= data.inicio
        && data.siguiente >= data.inicio
        && data.siguiente <= data.fin + 1;
    }

    function consumoBloquePropio() {
      return signedIn()
        && (
          (resource.data.ownerUid is string && resource.data.ownerUid == request.auth.uid)
          || !(resource.data.ownerUid is string)
        )
        && request.resource.data.deviceId == resource.data.deviceId
        && request.resource.data.modulo == resource.data.modulo
        && request.resource.data.inicio == resource.data.inicio
        && request.resource.data.fin == resource.data.fin
        && request.resource.data.tamano == resource.data.tamano
        && request.resource.data.siguiente == resource.data.siguiente + 1
        && request.resource.data.siguiente <= resource.data.fin + 1
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['siguiente', 'actualizadoEn']);
    }

    function consecutivosValidos(data) {
      return data.compras is int
        && data.ventas is int
        && data.gastos is int
        && data.ventasMenores is int
        && data.remisiones is int
        && data.compras >= 0
        && data.ventas >= 0
        && data.gastos >= 0
        && data.ventasMenores >= 0
        && data.remisiones >= 0;
    }

    function consecutivosNoDisminuyen() {
      return request.resource.data.compras >= resource.data.compras
        && request.resource.data.ventas >= resource.data.ventas
        && request.resource.data.gastos >= resource.data.gastos
        && request.resource.data.ventasMenores >= resource.data.ventasMenores
        && request.resource.data.remisiones >= resource.data.remisiones;
    }

    match /consecutivo_bloques/{bloqueId} {
      allow read: if signedIn();

      // Reserva normal: usuario reserva su propio bloque (ownerUid = auth.uid).
      // Reserva/reasignacion manual: solo admin puede asignar a otro ownerUid.
      allow create: if bloqueValido(request.resource.data)
        && (
          (signedIn() && request.resource.data.ownerUid == request.auth.uid)
          || isAdmin()
        );

      allow update: if consumoBloquePropio()
        || (
          bloqueValido(request.resource.data)
          && (
            (signedIn() && request.resource.data.ownerUid == request.auth.uid)
            || isAdmin()
          )
        );

      allow delete: if isAdmin();
    }

    match /configuracion/consecutivos {
      allow read: if signedIn();

      // Admin puede editar libremente (incluye reset manual desde panel).
      // Usuarios autenticados solo pueden incrementar campos (reserva de bloques).
      allow update: if isAdmin()
        || (
          signedIn()
          && consecutivosValidos(request.resource.data)
          && request.resource.data.diff(resource.data).changedKeys().hasOnly([
            'compras', 'ventas', 'gastos', 'ventasMenores', 'remisiones'
          ])
          && consecutivosNoDisminuyen()
        );

      allow create, delete: if isAdmin();
    }

    match /usuarios/{uid} {
      // Se deja lectura publica para no romper el login actual por nombre.
      // Recomendado futuro: migrar login para no depender de lectura publica.
      allow read: if true;
      allow write: if isAdmin();
    }

    match /articulos/{id} {
      allow read, write: if signedIn();
    }
    match /proveedores/{id} {
      allow read, write: if signedIn();
    }
    match /compras/{id} {
      allow read, write: if signedIn();
    }
    match /ventas/{id} {
      allow read, write: if signedIn();
    }
    match /ventasMenores/{id} {
      allow read, write: if signedIn();
    }
    match /gastos/{id} {
      allow read, write: if signedIn();
    }
    match /remisiones/{id} {
      allow read, write: if signedIn();
    }
    match /movimientos_caja/{id} {
      allow read, write: if signedIn();
    }

    // Fallback
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
